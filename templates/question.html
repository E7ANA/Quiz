<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¨×’×•×œ - {{ question['topic'] }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-size: 0.95rem; }
        .answer-btn { white-space: normal; transition: transform 0.1s; }
        .answer-btn:active { transform: scale(0.98); }
        .img-preview { cursor: zoom-in; transition: opacity 0.2s; }
        .img-preview:hover { opacity: 0.9; }
        
        /* × ×™×•×•×˜ */
        .nav-square { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; border-radius: 4px; text-decoration: none; border: 1px solid #dee2e6; color: #6c757d; }
        .nav-square:hover { background-color: #e9ecef; color: #495057; }
        .nav-square-active { background-color: #198754 !important; border-color: #198754 !important; color: white !important; font-weight: bold; transform: scale(1.1); }
        .nav-square-answered { background-color: #0d6efd; border-color: #0d6efd; color: white !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-3 shadow-sm py-1">
    <div class="container-fluid">
        <a class="navbar-brand fs-6" href="{{ url_for('index') }}">ğŸ  ×¨××©×™</a>
        <span class="navbar-text text-white fs-6">×ª×¨×’×•×œ ×¨×¤×•××™</span>
    </div>
</nav>

<div class="container-fluid pb-4">
    <div class="row">
        <main class="col-12 col-md-8 col-lg-9 order-1 order-md-2 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary">{{ question['topic'] }}</span>
                        <small class="text-muted">ID: {{ question['id'] }}</small>
                    </div>
                    <div class="mt-1 d-flex justify-content-between">
                         <h6 class="text-primary mb-0 fw-bold">{{ question['sub_topic'] }}</h6>
                         <small class="text-secondary fw-bold">×©××œ×” {{ current_q_in_category }} / {{ total_q_in_category }}</small>
                    </div>
                </div>
                
                <div class="card-body">
                    <h5 class="card-title lh-base mb-3">{{ question['question_text'] }}</h5>

                    {% if question['image_path'] %}
                    <div class="text-center mb-4 bg-light p-3 rounded border">
                        <img src="{{ url_for('static', filename='images/' + question['image_path']) }}" 
                             class="img-fluid rounded shadow-sm img-preview" 
                             style="max-height: 300px;"
                             data-bs-toggle="modal" data-bs-target="#imageModal">
                        <div class="text-muted small mt-2"><i class="bi bi-zoom-in"></i> ×œ×—×¥ ×œ×”×’×“×œ×”</div>
                    </div>
                    {% endif %}
                    
                    <form id="quiz-form">
                        <input type="hidden" name="question_id" value="{{ question['id'] }}">
                        <div class="d-grid gap-2"> 
                            {% for option in options %}
                            <button type="button" class="btn btn-outline-dark text-start answer-btn" onclick="submitAnswer(this, '{{ option }}')">
                                {{ option }}
                            </button>
                            {% endfor %}
                        </div>
                    </form>

                    <div id="result-area" class="mt-3" style="display: none;">
                        <div id="alert-box" class="alert p-2 mb-2 shadow-sm"></div>
                        <div class="card bg-light border-0 shadow-sm">
                            <div class="card-body py-2">
                                <h6 class="fw-bold text-decoration-underline text-primary small">×”×¡×‘×¨:</h6>
                                <p id="explanation-text" class="mb-0 small lh-base"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-light d-flex justify-content-between">
                    <a href="{{ url_for('get_question', question_id=prev_id) if prev_id else '#' }}" class="btn btn-sm btn-outline-secondary px-3 {% if not prev_id %}disabled{% endif %}">âœ ×§×•×“×</a>
                    <a href="{{ url_for('get_question', question_id=next_id) if next_id else url_for('index') }}" class="btn btn-sm btn-primary px-3 fw-bold">{% if next_id %}×”×‘× â¬…{% else %}×¡×™×•× ğŸ{% endif %}</a>
                </div>
            </div>
        </main>

        <aside class="col-12 col-md-4 col-lg-3 order-2 order-md-1">
             <div class="card shadow-sm border-0" style="max-height: 80vh; overflow-y: auto;">
                <div class="card-header bg-dark text-white py-2 small">××¤×ª ×©××œ×•×ª</div>
                <div class="card-body bg-light p-2">
                    {% for topic, topic_data in navigation_data.items() %}
                        <div class="mb-2">
                            <strong class="text-dark small border-bottom border-primary d-block mb-1">{{ topic }}</strong>
                            {% for sub, questions in topic_data.sub_topics.items() %}
                                <div class="mb-2">
                                    <div class="text-muted" style="font-size: 0.7rem;">{{ sub }}</div>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for q_data in questions %}
                                            <a href="{{ url_for('get_question', question_id=q_data.id) }}" 
                                               id="nav-sq-{{ q_data.id }}"
                                               class="nav-square {% if q_data.id == question.id %}nav-square-active{% else %}nav-square-default{% endif %}"
                                               title="{{ q_data.text }}">
                                                {{ q_data.number }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </aside>
    </div>
</div>

{% if question['image_path'] %}
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body text-center position-relative">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
        <img src="{{ url_for('static', filename='images/' + question['image_path']) }}" class="img-fluid rounded shadow">
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function markAnsweredQuestions() {
        const answeredIds = JSON.parse(localStorage.getItem('answered_questions') || '[]');
        answeredIds.forEach(id => {
            const square = document.getElementById(`nav-sq-${id}`);
            if (square && !square.classList.contains('nav-square-active')) {
                square.classList.add('nav-square-answered');
            }
        });
    }
    document.addEventListener('DOMContentLoaded', markAnsweredQuestions);

    function submitAnswer(btn, selectedOption) {
        const form = document.getElementById('quiz-form');
        const qId = form.querySelector('input[name="question_id"]').value;
        const btns = form.querySelectorAll('button');
        
        btns.forEach(b => b.classList.add('disabled')); 

        const fd = new FormData();
        fd.append('question_id', qId);
        fd.append('selected_answer', selectedOption);

        fetch('/check_answer', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('explanation-text').innerHTML = data.explanation;
            
            if(data.is_correct) {
                btn.classList.replace('btn-outline-dark', 'btn-success');
                document.getElementById('alert-box').className = 'alert alert-success fw-bold py-1';
                document.getElementById('alert-box').innerHTML = 'âœ… × ×›×•×Ÿ!';
            } else {
                btn.classList.replace('btn-outline-dark', 'btn-danger');
                document.getElementById('alert-box').className = 'alert alert-danger fw-bold py-1';
                document.getElementById('alert-box').innerHTML = 'âŒ ×˜×¢×•×ª.';
                btns.forEach(b => {
                    if(b.innerText.includes(data.correct_answer)) b.classList.replace('btn-outline-dark', 'btn-success');
                });
            }
            
            let ans = JSON.parse(localStorage.getItem('answered_questions') || '[]');
            if(!ans.includes(parseInt(qId))) {
                ans.push(parseInt(qId));
                localStorage.setItem('answered_questions', JSON.stringify(ans));
            }
        });
    }
</script>
</body>
</html>