<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¨×’×•×œ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-size: 0.95rem; }
        .answer-lbl { white-space: normal; transition: all 0.1s; border-width: 2px; }
        .img-preview { cursor: zoom-in; }
        .nav-square { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; border-radius: 4px; text-decoration: none; border: 1px solid #dee2e6; color: #6c757d; }
        .nav-square:hover { background-color: #e9ecef; }
        .nav-square-active { background-color: #198754 !important; border-color: #198754 !important; color: white !important; font-weight: bold; transform: scale(1.1); }
        .nav-square-answered { background-color: #0d6efd; border-color: #0d6efd; color: white !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-3 shadow-sm py-1">
    <div class="container-fluid">
        <a class="navbar-brand fs-6" href="{{ url_for('index') }}">ğŸ  ×¨××©×™</a>
        <span class="text-white">×©××œ×” {{ current_q_in_category }} ××ª×•×š {{ total_q_in_category }}</span>
    </div>
</nav>

<div class="container-fluid pb-4">
    <div class="row">
        <main class="col-12 col-md-8 col-lg-9 order-1 order-md-2 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-primary">{{ question['topic'] }}</span>
                        <small class="text-muted">ID: {{ question['id'] }}</small>
                    </div>
                    <div class="fw-bold text-primary mt-1">{{ question['sub_topic'] }}</div>
                </div>
                
                <div class="card-body">
                    {% if request.args.get('edited') %}
                    <div class="alert alert-success alert-dismissible fade show p-2 mb-3 small">
                        âœ… ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!
                        <button type="button" class="btn-close p-2" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}

                    <h5 class="lh-base mb-3">{{ question['question_text'] }}</h5>

                    {% if question['image_path'] %}
                    <div class="text-center mb-4 bg-light p-2 rounded border">
                        <img src="{{ url_for('serve_image', filename=question['image_path']) }}" 
                             class="img-fluid rounded shadow-sm img-preview" 
                             style="max-height: 250px;"
                             data-bs-toggle="modal" data-bs-target="#imageModal">
                    </div>
                    {% endif %}
                    
                    {% set is_multi = '[' in question['correct_answer'] and ']' in question['correct_answer'] %}
                    {% if is_multi %}
                    <div class="alert alert-info py-1 px-2 small mb-3 border-info text-info-emphasis">
                        <i class="bi bi-ui-checks"></i> <strong>×‘×—×™×¨×” ××¨×•×‘×”:</strong> ×¡××Ÿ ××ª ×›×œ ×”×ª×©×•×‘×•×ª ×”× ×›×•× ×•×ª.
                    </div>
                    {% endif %}

                    <form id="quiz-form">
                        <input type="hidden" name="question_id" value="{{ question['id'] }}">
                        <div class="d-grid gap-2"> 
                            {% for option in options %}
                            <div class="position-relative">
                                <input type="{{ 'checkbox' if is_multi else 'radio' }}" 
                                       class="btn-check" 
                                       name="selected_answer" 
                                       id="opt-{{ loop.index }}" 
                                       value="{{ option }}" 
                                       autocomplete="off"
                                       {% if not is_multi %}onclick="checkNow()"{% endif %}>
                                
                                <label class="btn btn-outline-dark text-start w-100 answer-lbl py-2 px-3" for="opt-{{ loop.index }}">
                                    {{ option }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        {% if is_multi %}
                        <button type="button" class="btn btn-primary w-100 mt-3 shadow-sm fw-bold" onclick="checkNow()">
                            ×‘×“×•×§ ×ª×©×•×‘×” ğŸ”
                        </button>
                        {% endif %}
                    </form>

                    <div id="result-area" class="mt-3" style="display: none;">
                        <div id="alert-box" class="alert p-2 mb-2 shadow-sm"></div>
                        <div class="card bg-light border-0 shadow-sm">
                            <div class="card-body py-2">
                                <h6 class="fw-bold text-primary small text-decoration-underline">×”×¡×‘×¨:</h6>
                                <div id="explanation-text" class="small lh-base"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('get_question', question_id=prev_id) if prev_id else '#' }}" 
                       class="btn btn-sm btn-outline-secondary px-3 {% if not prev_id %}disabled{% endif %}">âœ ×§×•×“×</a>
                    
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('edit_question', question_id=question['id']) }}" 
                           class="btn btn-sm btn-outline-warning text-dark fw-bold border-0" title="×¢×¨×™×›×”">
                            <i class="bi bi-pencil-fill"></i>
                        </a>

                        <form action="{{ url_for('delete_question', question_id=question['id']) }}" method="POST" 
                              onsubmit="return confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×©××œ×” ×–×• ×œ×¦××™×ª×•×ª? ×”×¤×¢×•×œ×” ×ª××—×§ ××•×ª×” ×’× ××§×•×‘×¥ ×”××§×•×¨.');"
                              style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="××—×™×§×”">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </form>
                    </div>

                    <a href="{{ url_for('get_question', question_id=next_id) if next_id else url_for('index') }}" 
                       class="btn btn-sm btn-primary px-3 fw-bold">{% if next_id %}×”×‘× â¬…{% else %}×¡×™×•× ğŸ{% endif %}</a>
                </div>
            </div>
        </main>

        <aside class="col-12 col-md-4 col-lg-3 order-2 order-md-1">
             <div id="sidebar-content" class="card shadow-sm border-0" style="max-height: 80vh; overflow-y: auto;">
                <div class="card-header bg-dark text-white py-2 small">××¤×ª ×©××œ×•×ª</div>
                <div class="card-body bg-light p-2">
                    {% for topic, topic_data in navigation_data.items() %}
                        <div class="mb-2">
                            <strong class="text-dark small border-bottom border-primary d-block mb-1">{{ topic }}</strong>
                            {% for sub, questions in topic_data.sub_topics.items() %}
                                <div class="mb-2">
                                    <div class="text-muted" style="font-size: 0.7rem;">{{ sub }}</div>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for q_data in questions %}
                                            <a href="{{ url_for('get_question', question_id=q_data.id) }}" 
                                               id="nav-sq-{{ q_data.id }}"
                                               class="nav-square {% if q_data.id == question.id %}nav-square-active{% else %}nav-square-default{% endif %}"
                                               title="{{ q_data.text }}">
                                                {{ q_data.number }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </aside>
    </div>
</div>

{% if question['image_path'] %}
<div class="modal fade" id="imageModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content bg-transparent border-0"><div class="modal-body text-center position-relative"><button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button><img src="{{ url_for('serve_image', filename=question['image_path']) }}" class="img-fluid rounded shadow"></div></div></div></div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const sidebar = document.getElementById("sidebar-content");
        if (sidebar) {
            const scrollPos = localStorage.getItem("practiceSidebarScrollPos");
            if (scrollPos) sidebar.scrollTop = scrollPos;
            window.addEventListener("beforeunload", () => localStorage.setItem("practiceSidebarScrollPos", sidebar.scrollTop));
        }
        markAnsweredQuestions();
    });

    function markAnsweredQuestions() {
        const answeredIds = JSON.parse(localStorage.getItem('answered_questions') || '[]');
        answeredIds.forEach(id => {
            const sq = document.getElementById(`nav-sq-${id}`);
            if (sq && !sq.classList.contains('nav-square-active')) sq.classList.add('nav-square-answered');
        });
    }

    function checkNow() {
        const form = document.getElementById('quiz-form');
        const fd = new FormData(form);
        
        form.querySelectorAll('input, button').forEach(el => el.disabled = true);

        fetch('/check_answer', { method: 'POST', body: fd }).then(r => r.json()).then(data => {
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('explanation-text').innerHTML = data.explanation;
            
            const alertBox = document.getElementById('alert-box');
            alertBox.className = `alert fw-bold py-1 alert-${data.status === 'correct' ? 'success' : (data.status === 'partial' ? 'warning' : 'danger')}`;
            alertBox.innerHTML = data.message;

            document.querySelectorAll('input[name="selected_answer"]').forEach(input => {
                const label = document.querySelector(`label[for="${input.id}"]`);
                const val = input.value.trim();
                const isCorrect = data.correct_answers.some(c => c.trim() === val);

                if (isCorrect) { label.classList.remove('btn-outline-dark'); label.classList.add('btn-success'); }
                else if (input.checked) { label.classList.remove('btn-outline-dark'); label.classList.add('btn-danger'); }
            });
            
            const qId = form.querySelector('input[name="question_id"]').value;
            let ans = JSON.parse(localStorage.getItem('answered_questions') || '[]');
            if(!ans.includes(parseInt(qId))) {
                ans.push(parseInt(qId));
                localStorage.setItem('answered_questions', JSON.stringify(ans));
            }
        });
    }
</script>
</body>
</html>